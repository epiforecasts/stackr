<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>stackr • stackr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="stackr">
<meta property="og:description" content="stackr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stackr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/stackr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>stackr</h1>
            
      
      
      <div class="hidden name"><code>stackr.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>stackr</code> package provides an easy way to combine
predictions from individual time series or panel data models to an
ensemble. <code>stackr</code> stacks Models according to the Continuous
Ranked Probability Score (CRPS) over k-step ahead predictions. It is
therefore especially suited for timeseries and panel data. A function
for leave-one-out CRPS may be added in the future. Predictions need to
be predictive distributions represented by predictive samples. Usually,
these will be sets of posterior predictive simulation draws generated by
an MCMC algorithm.</p>
<p>Given some training data with true observed values as well as
predictive samples generated from different models,
<code>crps_weights</code> finds the optimal (in the sense of minimizing
expected cross-validation predictive error) weights to form an ensemble
from these models. Using these weights,
<code>mixture_from_samples</code> can then provide samples from the
optimal model mixture by drawing from the predictice samples of the
individual models in the correct proportion. This gives a mixture model
solely based on predictive samples and is in this regard superior to
other ensembling techniques like Bayesian Model Averaging.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>Here is an example of how to use <code>stackr</code> with a toy data
set. The data contains true observed values as well as predictive
samples generated by different models.</p>
<div class="section level4">
<h4 id="load-example-data-and-split-into-train-and-test-data">Load example data and split into train and test data<a class="anchor" aria-label="anchor" href="#load-example-data-and-split-into-train-and-test-data"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">"data.table"</a></span><span class="op">)</span></span>
<span><span class="va">splitdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-28"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;         geography model sample_nr       date   y_pred    y_obs</span></span>
<span><span class="co">#&gt;      1:  Tatooine ARIMA         1 2020-03-14 1.719445 1.655068</span></span>
<span><span class="co">#&gt;      2:  Tatooine ARIMA         2 2020-03-14 1.896555 1.655068</span></span>
<span><span class="co">#&gt;      3:  Tatooine ARIMA         3 2020-03-14 1.766821 1.655068</span></span>
<span><span class="co">#&gt;      4:  Tatooine ARIMA         4 2020-03-14 1.714007 1.655068</span></span>
<span><span class="co">#&gt;      5:  Tatooine ARIMA         5 2020-03-14 1.726421 1.655068</span></span>
<span><span class="co">#&gt;     ---                                                       </span></span>
<span><span class="co">#&gt; 103996: Coruscant Naive       496 2020-04-08 1.460421 1.543976</span></span>
<span><span class="co">#&gt; 103997: Coruscant Naive       497 2020-04-08 1.057846 1.543976</span></span>
<span><span class="co">#&gt; 103998: Coruscant Naive       498 2020-04-08 1.433936 1.543976</span></span>
<span><span class="co">#&gt; 103999: Coruscant Naive       499 2020-04-08 1.719357 1.543976</span></span>
<span><span class="co">#&gt; 104000: Coruscant Naive       500 2020-04-08 0.781818 1.543976</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traindata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="va">splitdate</span><span class="op">]</span></span>
<span><span class="va">testdata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&gt;</span> <span class="va">splitdate</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get-weights-and-create-mixture">Get weights and create mixture<a class="anchor" aria-label="anchor" href="#get-weights-and-create-mixture"></a>
</h4>
<p>Obtain weights based on trainin data, create mixture based on
predictive samples in the testing data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu">stackr</span><span class="fu">::</span><span class="fu"><a href="../reference/crps_weights.html">crps_weights</a></span><span class="op">(</span><span class="va">traindata</span><span class="op">)</span></span>
<span><span class="va">test_mixture</span> <span class="op">&lt;-</span> <span class="fu">stackr</span><span class="fu">::</span><span class="fu"><a href="../reference/mixture_from_samples.html">mixture_from_samples</a></span><span class="op">(</span><span class="va">testdata</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">test_mixture</span><span class="op">)</span></span>
<span><span class="co">#&gt;        geography       date sample_nr     y_obs    y_pred        model</span></span>
<span><span class="co">#&gt;     1: Coruscant 2020-03-29         1 1.5002089 1.6240687 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     2: Coruscant 2020-03-29         2 1.5002089 3.0901112 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     3: Coruscant 2020-03-29         3 1.5002089 1.9486626 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     4: Coruscant 2020-03-29         4 1.5002089 2.3876041 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     5: Coruscant 2020-03-29         5 1.5002089 1.2970752 CRPS_Mixture</span></span>
<span><span class="co">#&gt;    ---                                                                </span></span>
<span><span class="co">#&gt; 10996:  Tatooine 2020-04-08       496 0.7719879 0.3652143 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10997:  Tatooine 2020-04-08       497 0.7719879 0.4735264 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10998:  Tatooine 2020-04-08       498 0.7719879 0.1382406 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10999:  Tatooine 2020-04-08       499 0.7719879 0.6907741 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 11000:  Tatooine 2020-04-08       500 0.7719879 0.4536809 CRPS_Mixture</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="score-predictions">Score predictions<a class="anchor" aria-label="anchor" href="#score-predictions"></a>
</h4>
<p>Score predictions using the <code>scoringutils</code> package
(install from CRAN using
<code>install.packages("scoringutils")</code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine data.frame with mixture with predictions from other models</span></span>
<span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">testdata</span>, <span class="va">test_mixture</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># CRPS score for all predictions using scoringutils</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="va">crps</span> <span class="op">:=</span> <span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">crps</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">y_obs</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y_pred</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">geography</span>, <span class="va">model</span>, <span class="va">date</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># summarise scores</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">crps</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">model</span><span class="op">]</span><span class="op">[</span>, <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="st">"V1"</span>, <span class="st">"CRPS"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Display other metrics</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span></span>
<span>  <span class="va">score_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"y_obs"</span>, <span class="st">"sample_nr"</span>, <span class="st">"y_pred"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"true_values"</span>, <span class="st">"sample"</span>, <span class="st">"predictions"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">eval_forecasts</span><span class="op">(</span><span class="va">score_df</span><span class="op">[</span><span class="va">geography</span> <span class="op">==</span> <span class="st">"Tatooine"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">eval_forecasts</span><span class="op">(</span><span class="va">score_df</span><span class="op">[</span><span class="va">geography</span> <span class="op">==</span> <span class="st">"Coruscant"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h2>
<p>Given a cumulative distribution function (CDF) with a finite first
moment of a probabilistic forecast, the corresponding Continuous Ranked
Probability Score can be written as <span class="math display">\[crps(F,y)=\mathbb{E}_X|X-y|-
\frac{1}{2}\mathbb{E}_{X,X^\prime}|X-X^\prime|.\tag{1}\]</span></p>
<div class="section level3">
<h3 id="crps-for-one-model-and-one-single-observation">CRPS for one model and one single observation<a class="anchor" aria-label="anchor" href="#crps-for-one-model-and-one-single-observation"></a>
</h3>
<p>The CRPS can be used to stack different models to obtain one ensemble
mixture model. Let us assume we have data from <span class="math inline">\(T\)</span> time points <span class="math inline">\(t = 1, \dots, T\)</span> in <span class="math inline">\(R\)</span> regions <span class="math inline">\(1,
\dots, R\)</span>. Observations are denoted <span class="math inline">\(y_{tr}\)</span>. Predictive samples are generated
from <span class="math inline">\(K\)</span> different models <span class="math inline">\(k, \dots, K\)</span>. For every observation <span class="math inline">\(y_{tr}\)</span> the <span class="math inline">\(S\)</span> predictive samples are denoted <span class="math inline">\(x_{1ktr}, \dots, x_{Sktr}\)</span>.</p>
<p>Using these predictive draws, we can compute the CRPS of the <span class="math inline">\(k\)</span>-th model for the observation <span class="math inline">\(y_{tr}\)</span> at time <span class="math inline">\(t\)</span> in region <span class="math inline">\(r\)</span> as</p>
<p><span class="math display">\[ \widehat {crps}_{ktr}= \widehat
{crps}_(x_{1ktr}, \dots, x_{Sktr},y_{tr})= \frac{1}{S}
\sum_{s=1}^S  |x_{sktr}-y_{tr}| -
\frac{1}{2S^2} \sum_{s, j=1}^S |x_{sktr}- x_{jktr}|.
\tag{2}\]</span></p>
</div>
<div class="section level3">
<h3 id="crps-for-a-mixture-of-all-models-and-one-single-observation">CRPS for a mixture of all models and one single observation<a class="anchor" aria-label="anchor" href="#crps-for-a-mixture-of-all-models-and-one-single-observation"></a>
</h3>
<p>Now we want to aggregate predictions from these <span class="math inline">\(K\)</span> models. When the prediction is a
mixture of the <span class="math inline">\(K\)</span> models with
weights <span class="math inline">\(w_1, \dots, w_s\)</span>, the CRPS
can be expressed as</p>
<p><span class="math display">\[ \widehat {crps}_{agg, tr} (w_1, \dots,
w_K) = \frac{1}{S} \sum_{k=1}^K w_k  \sum_{s=1}^S |x_{skt}-y_t| -
\frac{1}{2S^2}  (\sum_{k=1}^K   \sum_{k, k'=1 }^K w_k
w_{k'}   \sum_{s, j=1}^S |x_{skt}- x_{jk't}| ).
\tag{3}\]</span></p>
<p>This expression is quadratic in <span class="math inline">\(w\)</span>. We only need to compute <span class="math inline">\(\sum_{s=1}^S |x_{skt}-y_{tr}|\)</span>, <span class="math inline">\(\sum_{s, j=1}^S |x_{sktr}- x_{jktr}|\)</span>, and
<span class="math inline">\(\sum_{s, j=1}^S |x_{sktr}-
x_{jk'tr}|\)</span> for all <span class="math inline">\(k,
k'\)</span> pairs once and store them for all weight values in the
optimization.</p>
</div>
<div class="section level3">
<h3 id="obtaining-the-weights-that-minimize-crps">Obtaining the weights that minimize CRPS<a class="anchor" aria-label="anchor" href="#obtaining-the-weights-that-minimize-crps"></a>
</h3>
<p>The CRPS for the mixture of all models for all observations can
simply obtained by summing up the individual results from equation 3
over all regions and time points. However, we can also weight
predictions from different time points and regions differently. This
makes sense for example if we have very little data in the beginning or
if current older observations are less characteristic of the current and
future dynamics. In this case we might want to downweight the early
phase in the final model evaluation. Similarly, we might want to give
more or less weight to certain regions. Mathematically we can introduce
a time-varying weight <span class="math inline">\(\lambda_1, \dots,
\lambda_T\)</span>, e.g. <span class="math inline">\(\lambda_t =
2-(1-t/T)^2\)</span> to penalize earler estimates. Likewise we can
introduce a region-specific weight <span class="math inline">\(\tau_r\)</span>.</p>
<p>To obtain the CRPS weights we finally solve a quadratic
optimization:</p>
<p><span class="math display">\[\begin{align*}
&amp;\min_{w_1, \dots, w_K}
\sum_{t=1}^T  \sum_{r=1}^R\lambda_t\tau_r  \widehat {crps}_{agg, tr}
(w), \\
  &amp;s.t. ~{0\leq w_1, \dots, w_K \leq 1, \sum_{k=1}^K w_k=1}.
\end{align*}\]</span></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Using Stacking to Average Bayesian Predictive Distributions, Yuling
Yao, Aki Vehtari, Daniel Simpson, and Andrew Gelman, 2018, Bayesian
Analysis 13, Number 3, pp. 917–1003 <a href="doi:10.1214/17-BA1091" class="uri">doi:10.1214/17-BA1091</a>
</li>
<li>Strictly Proper Scoring Rules, Prediction,and Estimation, Tilmann
Gneiting and Adrian E. Raftery, 2007, Journal of the American
Statistical Association, Volume 102, 2007 - Issue 477 <a href="doi:10.1198/016214506000001437" class="uri">doi:10.1198/016214506000001437</a>
</li>
<li>Comparing Bayes Model Averaging and Stacking When Model
Approximation Error Cannot be Ignored, Bertrand Clarke, 2003, Journal of
Machine Learning Research 4</li>
<li>Bayesian Model Weighting: The Many Faces of Model Averaging, Marvin
Höge, Anneli Guthke and Wolfgang Nowak, 2020, Water, <a href="doi:10.3390/w12020309" class="uri">doi:10.3390/w12020309</a>
</li>
<li>Bayesian Stacking and Pseudo-BMA weights using the loo package, Aki
Vehtari and Jonah Gabry, 2019, <a href="https://mc-stan.org/loo/articles/loo2-weights.html" class="external-link uri">https://mc-stan.org/loo/articles/loo2-weights.html</a>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nikos Bosse, Yuling Yao, Sam Abbott, Sebastian Funk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

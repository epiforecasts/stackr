<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Mixture Models From Predictive Samples • stackr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Create Mixture Models From Predictive Samples">
<meta property="og:description" content="
      The `stackr` package provides an easy way to combine predictions
      from individual time series or panel data models to an 
      ensemble. `stackr` stacks (Yuling Yao, Aki Vehtari, Daniel Simpson, 
      and Andrew Gelman (2018) &lt;doi:10.1214/17-BA1091&gt;)
      Models according to the Continuous Ranked 
      Probability Score (CRPS) (Tilmann Gneiting &amp; Adrian E Raftery (2007) 
      &lt;doi:10.1198/016214506000001437&gt;) over k-step ahead predictions. It is therefore 
      especially suited for timeseries and panel data. A function for 
      leave-one-out CRPS may be added in the future. Predictions need to be 
      predictive distributions represented by predictive samples. Usually, these will 
      be sets of posterior predictive simulation draws generated by an MCMC 
      algorithm. 
      Given some training data with true observed values as well as predictive samples
      generated from different models, `crps_weights` finds the optimal (in the sense of 
      minimizing expected cross-validation predictive error) weights 
      to form an ensemble from these models. Using these weights, 
      `mixture_from_samples` can then provide samples from the optimal 
      model mixture by drawing from the predictice samples
      of the individual models in the correct proportion. This gives a mixture model
      solely based on predictive samples and is in this regard superior to other 
      ensembling techniques like Bayesian Model Averaging. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">stackr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="articles/stackr.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="stackr-package">stackr package<a class="anchor" aria-label="anchor" href="#stackr-package"></a>
</h1></div>
<!-- badges: start -->

</div>
<div class="section level1">
<h1 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h1>
<p>The <code>stackr</code> package provides an easy way to combine predictions from individual time series or panel data models to an ensemble. <code>stackr</code> stacks Models according to the Continuous Ranked Probability Score (CRPS) over k-step ahead predictions. It is therefore especially suited for timeseries and panel data. A function for leave-one-out CRPS may be added in the future. Predictions need to be predictive distributions represented by predictive samples. Usually, these will be sets of posterior predictive simulation draws generated by an MCMC algorithm.</p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<p>install using</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"epiforecasts/stackr"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="crps-stacking">CRPS Stacking<a class="anchor" aria-label="anchor" href="#crps-stacking"></a>
</h1>
<p>Given some training data with true observed values as well as predictive samples generated from different models, <code>stackr</code> finds the optimal (in the sense of minimizing expected cross-validation predictive error) weights to form an ensemble of these models. Using these weights, stackr can then provide samples from the optimal model mixture by drawing from the predictice samples of those models in the correct proportion. This gives a mixture model solely based on predictive samples and is in this regard superior to other ensembling techniques like Bayesian Model Averaging. More information can be found in the package vignette.</p>
<p>Weights are generated using the <code>crps_weights</code> function. With these weights and predictive samples, the <code>mixture_from_samples</code> function can be used to obtain predictive samples from the optimal mixture model.</p>
</div>
<div class="section level1">
<h1 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h1>
<div class="section level2">
<h2 id="load-example-data-and-split-into-train-and-test-data">Load example data and split into train and test data<a class="anchor" aria-label="anchor" href="#load-example-data-and-split-into-train-and-test-data"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">splitdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-28"</span><span class="op">)</span></span>
<span><span class="va">traindata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="va">splitdate</span><span class="op">]</span></span>
<span><span class="va">testdata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&gt;</span> <span class="va">splitdate</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-weights-and-create-mixture">Get weights and create mixture<a class="anchor" aria-label="anchor" href="#get-weights-and-create-mixture"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/crps_weights.html">crps_weights</a></span><span class="op">(</span><span class="va">traindata</span><span class="op">)</span></span>
<span><span class="va">test_mixture</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/mixture_from_samples.html">mixture_from_samples</a></span><span class="op">(</span><span class="va">testdata</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="score-predictions">Score predictions<a class="anchor" aria-label="anchor" href="#score-predictions"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://epiforecasts.io/scoringutils/" class="external-link">"scoringutils"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine data.frame with mixture with predictions from other models</span></span>
<span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">testdata</span>, <span class="va">test_mixture</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># score all predictions using from github.com/epiforecasts/scoringutils</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="va">crps</span> <span class="op">:=</span> <span class="fu">crps</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">y_obs</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y_pred</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">geography</span>, <span class="va">model</span>, <span class="va">date</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># summarise scores</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">crps</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">model</span><span class="op">]</span><span class="op">[</span>, <span class="fu">setnames</span><span class="op">(</span><span class="va">.SD</span>, <span class="st">"V1"</span>, <span class="st">"CRPS"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<ul>
<li>Using Stacking to Average Bayesian Predictive Distributions, Yuling Yao, Aki Vehtari, Daniel Simpson, and Andrew Gelman, 2018, Bayesian Analysis 13, Number 3, pp. 917–1003 DOI 10.1214/17-BA1091</li>
<li>Strictly Proper Scoring Rules, Prediction,and Estimation, Tilmann Gneiting and Adrian E. Raftery, 2007, Journal of the American Statistical Association, Volume 102, 2007 - Issue 477 DOI 10.1198/016214506000001437</li>
<li>Comparing Bayes Model Averaging and Stacking When Model Approximation Error Cannot be Ignored, Bertrand Clarke, 2003, Journal of Machine Learning Research 4</li>
<li>Bayesian Model Weighting: The Many Faces of Model Averaging, Marvin Höge, Anneli Guthke and Wolfgang Nowak, 2020, Water, DOI 10.3390/w12020309</li>
<li>Bayesian Stacking and Pseudo-BMA weights using the loo package, Aki Vehtari and Jonah Gabry, 2019, <a href="https://mc-stan.org/loo/articles/loo2-weights.html" class="external-link uri">https://mc-stan.org/loo/articles/loo2-weights.html</a>
</li>
</ul>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing stackr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Nikos Bosse <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-7750-5280" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Yuling Yao <br><small class="roles"> Author </small>  </li>
<li>Sam Abbott <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0001-8057-8037" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Sebastian Funk <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-2842-3406" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/epiforecasts/stackr/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/epiforecasts/stackr/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://codecov.io/github/epiforecasts/stackr" class="external-link"><img src="https://codecov.io/github/epiforecasts/stackr/branch/main/graph/badge.svg?token=rYeyG3kFIa" alt="codecov"></a></li>
<li><a href="https://opensource.org/licenses/MIT" class="external-link"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Nikos Bosse, Yuling Yao, Sam Abbott, Sebastian Funk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
